# https://hub.docker.com/r/library/python/tags/
image: "python:3.7"

before_script:
- python3 --version
- pip3 install --upgrade pip setuptools

stages:
- build
- test
- deploy

variables:
  GIT_DEPTH: 1
  LC_ALL: "C"
  GIT_STRATEGY: clone
  GIT_SUBMODULE_STRATEGY: recursive
  HIVEMIND_DB_NAME: $HIVEMIND_DB_NAME
  HIVEMIND_SOURCE_HIVED_URL: $HIVEMIND_SOURCE_HIVED_URL
  PYTHONUSERBASE: ./local-site

hivemind_build:
  stage: build
  script:
    - "python3 setup.py bdist_egg"
    - ls -l dist/*
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  tags:
     - hivemind

hivemind_deploy:
  stage: deploy
  needs:
    - job: hivemind_build
      artifacts: true
  variables:
    GIT_STRATEGY: none
  script:
    - ls -l dist/*
    - mkdir -p `python3 -m site --user-site`
    - python3 setup.py install --user --force
    - ./local-site/bin/hive --version
    - "echo Attempting to recreate database $HIVEMIND_DB_NAME"
    - "echo Attempting to starting hive sync using hived node: $HIVEMIND_SOURCE_HIVED_URL"
  tags:
     - hivemind
